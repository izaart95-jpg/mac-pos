name: macOS Remote Access Setup

on:
  workflow_dispatch:

jobs:
  setup-remote-access:
    runs-on: macos-latest
    timeout-minutes: 30  # Total 30 minutes: 10 for setup + 20 keepalive

    steps:
      - name: Setup VNC with ARD
        run: |
          echo "=== Setting up Apple Remote Desktop/VNC ==="
          
          # Activate and configure ARD agent
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -restart -agent -privs -all
          
          # Enable legacy VNC
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvnclegacy yes -vnclegacy yes
          
          # Set VNC password
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvncpw yourpassword -vncpw yourpassword
          
          # Allow access for all users
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -allowAccessFor -allUsers
          
          echo "✅ VNC/ARD setup complete"
          echo "VNC Password: yourpassword"

      - name: Install Tailscale
        run: |
          echo "=== Installing Tailscale ==="
          
          # Install Tailscale
          curl -fsSL https://tailscale.com/install.sh | sh
          
          # Start tailscaled service
          echo "Starting tailscaled service..."
          sudo tailscaled 2>/dev/null || true
          
          # Wait a moment
          sleep 3

      - name: Authenticate Tailscale
        run: |
          echo "=== Authenticating Tailscale ==="
          
          # Try tailscale command
          if command -v tailscale &> /dev/null; then
            echo "Tailscale command found at: $(which tailscale)"
          else
            echo "Tailscale command not found, trying alternatives..."
            
            # Try to start via the app
            sudo /Applications/Tailscale.app/Contents/MacOS/Tailscale --cleanup 2>/dev/null || true
            sudo tailscaled 2>/dev/null || true
            sleep 2
          fi
          
          # If still not found, install via Homebrew
          if ! command -v tailscale &> /dev/null; then
            echo "Installing Homebrew and Tailscale..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            brew install tailscale
            sudo brew services start tailscaled
            sleep 5
          fi
          
          # Authenticate with Tailscale
          AUTH_KEY="tskey-auth-katBTfGaCP11CNTRL-hMqSUZh4fgPZNHebqNt7gPCxLc3sP2pf"
          
          for attempt in {1..3}; do
            echo "Authentication attempt $attempt..."
            if sudo tailscale up --authkey "$AUTH_KEY" 2>&1; then
              echo "✅ Tailscale authentication successful"
              break
            fi
            sleep 3
          done
          
          # Wait for connection
          sleep 5

      - name: Display Connection Info
        run: |
          echo "=== Connection Information ==="
          
          # Get Tailscale IP
          echo "Tailscale IP:"
          tailscale ip 2>/dev/null || echo "Could not get Tailscale IP"
          
          echo ""
          echo "Tailscale Status:"
          tailscale status 2>/dev/null || echo "Tailscale status command failed"
          
          echo ""
          echo "VNC Information:"
          echo "  Password: yourpassword"
          echo "  Port: 5900"
          
          # Check if VNC is listening
          echo ""
          echo "VNC Port Status:"
          sudo lsof -i :5900 2>/dev/null || echo "VNC not listening on port 5900"

      - name: Keep system running for 20 minutes
        run: |
          echo "=== System Setup Complete ==="
          echo ""
          echo "✅ VNC/ARD Enabled"
          echo "   Password: yourpassword"
          echo "   Port: 5900"
          echo ""
          echo "✅ Tailscale VPN Active"
          echo ""
          echo "=== Keeping system alive for 20 minutes ==="
          echo "Start time: $(date)"
          echo "Will run until: $(date -v+20M)"
          echo ""
          
          # Display status every minute
          for i in {1..20}; do
            echo ""
            echo "=== Minute $i/20 ==="
            echo "Time: $(date)"
            
            # Show Tailscale status
            if command -v tailscale &> /dev/null; then
              echo "Tailscale IP: $(tailscale ip 2>/dev/null || echo 'Unknown')"
            fi
            
            # Show VNC status
            if sudo lsof -i :5900 &>/dev/null; then
              echo "VNC: ✅ Listening on port 5900"
            else
              echo "VNC: ❌ Not listening"
            fi
            
            # Countdown
            remaining=$((20 - i))
            if [ $remaining -gt 0 ]; then
              echo "Remaining: ${remaining} minutes"
              sleep 60
            fi
          done
          
          echo ""
          echo "✅ 20 minutes complete. Workflow ending."

      - name: Final cleanup
        if: always()
        run: |
          echo "=== Final Cleanup ==="
          
          # Disconnect Tailscale
          sudo tailscale down 2>/dev/null || true
          
          # Optional: Disable VNC/ARD if desired
          # sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          #   -deactivate -configure -access -off 2>/dev/null || true
          
          echo "✅ Cleanup complete"
