name: SSHX Remote Access with Screenshots

on:
  workflow_dispatch:

jobs:
  setup-sshx:
    runs-on: macos-latest
    timeout-minutes: 25  # 5 minutes setup + 20 minutes keepalive

    steps:
      - name: Create screenshot directory
        run: |
          mkdir -p screenshots
          echo "SCREENSHOT_DIR=$(pwd)/screenshots" >> $GITHUB_ENV
          echo "SSHX_SESSION_FILE=$(pwd)/sshx_session.txt" >> $GITHUB_ENV

      - name: Take initial screenshot
        run: |
          echo "=== Taking initial screenshot ==="
          screenshot_file="$SCREENSHOT_DIR/initial_$(date +%s).png"
          sudo screencapture -x "$screenshot_file" 2>/dev/null || true
          
          if [ -f "$screenshot_file" ] && [ -s "$screenshot_file" ]; then
            size=$(ls -lh "$screenshot_file" | awk '{print $5}')
            echo "âœ… Initial screenshot saved: ${size}"
          else
            echo "âš ï¸ Could not take initial screenshot"
          fi

      - name: Install and run sshx
        run: |
          echo "=== Installing and running sshx ==="
          
          # Install sshx
          echo "Installing sshx..."
          curl -sSf https://sshx.io/get | sh
          
          # Run sshx in background and capture session info
          echo "Starting sshx session..."
          (sshx --background 2>&1 | tee "$SSHX_SESSION_FILE") &
          SSHX_PID=$!
          echo "SSHX_PID=$SSHX_PID" >> $GITHUB_ENV
          
          # Wait for sshx to initialize
          sleep 10
          
          # Get session URL if available
          echo ""
          echo "=== SSHX Session Info ==="
          if [ -f "$SSHX_SESSION_FILE" ]; then
            grep -i "connect\|join\|session\|http" "$SSHX_SESSION_FILE" | head -5
          fi
          
          # Take screenshot after sshx starts
          echo ""
          echo "Taking post-startup screenshot..."
          screenshot_file="$SCREENSHOT_DIR/post_startup_$(date +%s).png"
          sudo screencapture -x "$screenshot_file" 2>/dev/null || true
          echo "âœ… Setup complete"

      - name: Upload initial artifacts
        uses: actions/upload-artifact@v4
        with:
          name: initial-screenshots
          path: |
            ${{ env.SCREENSHOT_DIR }}
            ${{ env.SSHX_SESSION_FILE }}
          retention-days: 1

      - name: Keep system alive for 20 minutes
        run: |
          echo "=== SSHX Remote Access Active ==="
          echo ""
          echo "âœ… sshx session is running"
          echo "âœ… Screenshots being captured every 2 minutes"
          echo ""
          echo "Start time: $(date)"
          echo "Will keep alive until: $(date -v+20M)"
          echo ""
          
          # Display session info if available
          if [ -f "$SSHX_SESSION_FILE" ]; then
            echo "=== Session Information ==="
            grep -i "connect\|join\|session\|http" "$SSHX_SESSION_FILE" | head -5
            echo ""
          fi
          
          # Run for 20 minutes, taking screenshots every 2 minutes
          for minute in {1..20}; do
            echo ""
            echo "=== Minute $minute/20 ==="
            echo "Time: $(date)"
            
            # Check if sshx is still running
            if ps -p $SSHX_PID > /dev/null 2>&1; then
              echo "âœ… sshx: Running (PID: $SSHX_PID)"
            else
              echo "âŒ sshx: Not running, restarting..."
              (sshx --background 2>&1 | tee -a "$SSHX_SESSION_FILE") &
              SSHX_PID=$!
              echo "New PID: $SSHX_PID"
            fi
            
            # Take screenshot every 2 minutes
            if [ $((minute % 2)) -eq 0 ]; then
              timestamp=$(date +%Y%m%d_%H%M%S)
              screenshot_file="$SCREENSHOT_DIR/periodic_${timestamp}.png"
              echo "ðŸ“¸ Taking screenshot..."
              sudo screencapture -x "$screenshot_file" 2>/dev/null || true
              
              if [ -f "$screenshot_file" ] && [ -s "$screenshot_file" ]; then
                size=$(ls -lh "$screenshot_file" | awk '{print $5}')
                echo "   Saved: $(basename "$screenshot_file") (${size})"
              fi
            fi
            
            # Countdown
            remaining=$((20 - minute))
            if [ $remaining -gt 0 ]; then
              echo "â³ Remaining: ${remaining} minutes"
              sleep 60  # Wait 1 minute
            fi
          done
          
          echo ""
          echo "âœ… 20 minutes complete. Session ending."

      - name: Upload final screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: final-screenshots
          path: |
            ${{ env.SCREENSHOT_DIR }}
          retention-days: 1

      - name: Cleanup
        if: always()
        run: |
          echo "=== Cleaning up ==="
          
          # Kill sshx process
          if [ ! -z "$SSHX_PID" ] && ps -p $SSHX_PID > /dev/null 2>&1; then
            echo "Stopping sshx (PID: $SSHX_PID)..."
            kill $SSHX_PID 2>/dev/null || true
          fi
          
          # Kill any other sshx processes
          pkill -f "sshx" 2>/dev/null || true
          
          echo "âœ… Cleanup complete"
