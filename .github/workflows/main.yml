name: RustDesk Screenshot macOS

on:
  workflow_dispatch:

jobs:
  rustdesk-screenshot:
    runs-on: macos-latest
    timeout-minutes: 10  # Should complete in a few minutes

    steps:
      - name: Download and install RustDesk
        run: |
          curl -L -o rustdesk.dmg "https://github.com/rustdesk/rustdesk/releases/download/1.4.4/rustdesk-1.4.4-x86_64.dmg"
          hdiutil attach rustdesk.dmg -mountpoint /Volumes/RustDesk -nobrowse
          sudo cp -R "/Volumes/RustDesk/RustDesk.app" /Applications/
          hdiutil detach /Volumes/RustDesk

      - name: Create screenshot directory
        run: |
          mkdir -p screenshots
          echo "SCREENSHOT_DIR=$(pwd)/screenshots" >> $GITHUB_ENV

      - name: Set permissions for screen recording
        run: |
          # Grant permissions to bash for screen recording
          sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceScreenRecording','/bin/bash',0,1,1,NULL,NULL,NULL,'UNUSED',NULL,0,strftime('%s','now'));" 2>/dev/null || true
          sudo pkill -9 TCC 2>/dev/null || true
          sleep 2

      - name: Start RustDesk and take screenshot
        run: |
          # Start RustDesk
          open -a /Applications/RustDesk.app
          sleep 5
          
          # Take screenshot
          screenshot_file="$SCREENSHOT_DIR/rustdesk_screenshot.png"
          screencapture -x "$screenshot_file"
          
          if [ -f "$screenshot_file" ] && [ -s "$screenshot_file" ]; then
            echo "✅ Screenshot captured: $screenshot_file"
            ls -lh "$screenshot_file"
          else
            echo "❌ Failed to capture screenshot"
          fi

      - name: Upload screenshot artifact
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-screenshot
          path: ${{ env.SCREENSHOT_DIR }}/*.png
          retention-days: 1

      - name: Cleanup
        if: always()
        run: |
          pkill -f "RustDesk" 2>/dev/null || true
          rm -f rustdesk.dmg 2>/dev/null || true
