name: macOS Settings Screenshot

on:
  workflow_dispatch:

jobs:
  settings-screenshots:
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - name: Create screenshot directory
        run: |
          mkdir -p screenshots
          echo "SCREENSHOT_DIR=$(pwd)/screenshots" >> $GITHUB_ENV

      - name: Open System Settings
        run: |
          # Close System Settings if already open
          osascript -e 'tell application "System Settings" to quit' 2>/dev/null || true
          sleep 2
          
          # Open System Settings to main page
          open -a "System Settings"
          sleep 3
          
          # Wait for System Settings to fully load
          osascript -e '
            tell application "System Settings"
              activate
              delay 3
            end tell
          '

      - name: Take screenshot of main Settings window
        run: |
          echo "Taking screenshot of main Settings window..."
          
          # Get window ID of System Settings
          window_info=$(osascript << 'EOF'
            tell application "System Events"
              tell process "System Settings"
                if exists window 1 then
                  set windowPos to position of window 1
                  set windowSize to size of window 1
                  return windowPos & "," & windowSize
                else
                  return "0,0,800,600"
                end if
              end tell
            end tell
          EOF
          )
          
          # Take full screen screenshot
          timestamp=$(date +%Y%m%d_%H%M%S)
          screenshot_file="$SCREENSHOT_DIR/settings_main_${timestamp}.png"
          screencapture -x "$screenshot_file"
          
          # Crop if we got window info
          if [[ "$window_info" != "0,0,800,600" ]]; then
            IFS=',' read -r posX posY sizeX sizeY <<< "$window_info"
            echo "Window info: Position ($posX, $posY), Size ($sizeX, $sizeY)"
          fi
          
          echo "✓ Screenshot saved: $screenshot_file"

      - name: Navigate to General and take screenshot
        run: |
          echo "Navigating to General settings..."
          
          osascript << 'EOF'
            tell application "System Settings"
              activate
              delay 1
            end tell
            
            tell application "System Events"
              tell process "System Settings"
                # Navigate to General
                repeat with sidebarItem in outline 1 of scroll area 1 of group 1 of splitter group 1 of window 1
                  try
                    if name of static text 1 of UI element 1 of sidebarItem contains "General" then
                      select sidebarItem
                      log "Selected General"
                      delay 2
                      exit repeat
                    end if
                  end try
                end repeat
                
                # Wait for General page to load
                delay 2
              end tell
            end tell
          EOF
          
          # Take screenshot
          timestamp=$(date +%Y%m%d_%H%M%S)
          screenshot_file="$SCREENSHOT_DIR/settings_general_${timestamp}.png"
          screencapture -x "$screenshot_file"
          echo "✓ General settings screenshot: $screenshot_file"

      - name: Navigate to Sharing and take screenshot
        run: |
          echo "Navigating to Sharing settings..."
          
          osascript << 'EOF'
            tell application "System Settings"
              activate
              delay 1
            end tell
            
            tell application "System Events"
              tell process "System Settings"
                # Navigate to General first if needed (for reliable navigation)
                repeat with sidebarItem in outline 1 of scroll area 1 of group 1 of splitter group 1 of window 1
                  try
                    if name of static text 1 of UI element 1 of sidebarItem contains "General" then
                      select sidebarItem
                      delay 1
                      exit repeat
                    end if
                  end try
                end repeat
                
                # Now navigate to Sharing
                repeat with sidebarItem in outline 1 of scroll area 1 of group 1 of splitter group 1 of window 1
                  try
                    if name of static text 1 of UI element 1 of sidebarItem contains "Sharing" then
                      select sidebarItem
                      log "Selected Sharing"
                      delay 2
                      exit repeat
                    end if
                  end try
                end repeat
                
                # Wait for Sharing page to load
                delay 2
              end tell
            end tell
          EOF
          
          # Take screenshot
          timestamp=$(date +%Y%m%d_%H%M%S)
          screenshot_file="$SCREENSHOT_DIR/settings_sharing_${timestamp}.png"
          screencapture -x "$screenshot_file"
          echo "✓ Sharing settings screenshot: $screenshot_file"

      - name: Alternative navigation method (if needed)
        if: failure()
        run: |
          echo "Trying alternative navigation method..."
          
          # Close and reopen to reset
          osascript -e 'tell application "System Settings" to quit' 2>/dev/null || true
          sleep 2
          
          # Open directly to specific URLs (macOS Ventura+)
          open "x-apple.systempreferences:com.apple.settings.General"
          sleep 3
          timestamp=$(date +%Y%m%d_%H%M%S)
          screencapture -x "$SCREENSHOT_DIR/alternative_general_${timestamp}.png"
          
          open "x-apple.systempreferences:com.apple.settings.Sharing"
          sleep 3
          timestamp=$(date +%Y%m%d_%H%M%S)
          screencapture -x "$SCREENSHOT_DIR/alternative_sharing_${timestamp}.png"

      - name: Take additional full screenshots with different methods
        run: |
          echo "Taking additional screenshots with different methods..."
          
          # Method 1: Full screen
          screencapture -x "$SCREENSHOT_DIR/fullscreen_1.png"
          sleep 1
          
          # Method 2: With timestamp
          screencapture -t png "$SCREENSHOT_DIR/fullscreen_2.png"
          sleep 1
          
          # Method 3: Without shadow
          screencapture -o -x "$SCREENSHOT_DIR/fullscreen_no_shadow.png"
          
          echo "✓ Additional screenshots taken"

      - name: List all screenshots
        run: |
          echo "=== Screenshots captured ==="
          ls -la "$SCREENSHOT_DIR/" || echo "No screenshots directory found"
          
          if [ -d "$SCREENSHOT_DIR" ]; then
            echo "Total files in $SCREENSHOT_DIR:"
            find "$SCREENSHOT_DIR" -type f -name "*.png" | wc -l
          fi

      - name: Upload screenshots as artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-settings-screenshots
          path: ${{ env.SCREENSHOT_DIR }}
          retention-days: 7
          if-no-files-found: error

      - name: Cleanup
        if: always()
        run: |
          echo "Cleaning up..."
          # Close System Settings
          osascript -e 'tell application "System Settings" to quit' 2>/dev/null || true
          
          # Kill any hanging processes
          pkill -f "System Settings" 2>/dev/null || true
          
          echo "Cleanup complete"
